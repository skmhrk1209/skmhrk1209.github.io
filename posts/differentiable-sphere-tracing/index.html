<!DOCTYPE html>
<html lang="ja" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Hiroki Sakuma" />
	
	
	
	<title>Differentiable Sphere Tracing ï½œ ğŸ¤</title>
	
    
    
    <meta name="description" content="CVPR&#39;20ã®è«–æ–‡ã‚’çœºã‚ã¦ã„ãŸã‚‰ï¼Œæœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹GLSLã¨é–¢é€£ã™ã‚‹é¢ç™½ãã†ãªè«–æ–‡ã‚’è¦‹ã¤ã‘ãŸï¼ Differentiable Volumetric Rendering: Learning Implicit 3D Representations without 3D Supervision [Niemeyer et al., CVPR&#39;20] DIST: Rendering Deep Implicit Signed Distance Function with Differentiable Sphere Tracing [Liu et al., CVPR&#39;20] SDFDiff: Differentiable Rendering of Signed Distance Fields for 3D Shape Optimization [Jiang et al., CVPR&#39;20] ã“ã“æœ€è¿‘ã®CVP" />
    

    
    
    <meta name="keywords" content="Max/MSP, GLSL, Cinder, PyTorch" />
    

	
    
    <link rel="shortcut icon" href="https://hirokisakuma.com/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://hirokisakuma.com/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://hirokisakuma.com/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://hirokisakuma.com/css/highlight.css" />

    
    
</head>

<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://hirokisakuma.com/">
                    <span>ğŸ¤</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">Hiroki Sakuma</p>
            <div class="my_socials">
                
                
                
                
                <a href="https://github.com/skmhrk1209" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                
                
                
                
                
                <a href="https://hirokisakuma.com/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/differentiable-sphere-tracing/'>Differentiable Sphere Tracing</a></h2>
                        <span class="date">2020.10.09</span>
                    </div>
                    <div class="post_content markdown"><p>CVPR'20ã®è«–æ–‡ã‚’çœºã‚ã¦ã„ãŸã‚‰ï¼Œæœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹GLSLã¨é–¢é€£ã™ã‚‹é¢ç™½ãã†ãªè«–æ–‡ã‚’è¦‹ã¤ã‘ãŸï¼</p>
<ol>
<li><a href="https://openaccess.thecvf.com/content_CVPR_2020/papers/Niemeyer_Differentiable_Volumetric_Rendering_Learning_Implicit_3D_Representations_Without_3D_Supervision_CVPR_2020_paper.pdf">Differentiable Volumetric Rendering: Learning Implicit 3D Representations without 3D Supervision [Niemeyer et al., CVPR'20]</a></li>
<li><a href="https://openaccess.thecvf.com/content_CVPR_2020/papers/Liu_DIST_Rendering_Deep_Implicit_Signed_Distance_Function_With_Differentiable_Sphere_CVPR_2020_paper.pdf">DIST: Rendering Deep Implicit Signed Distance Function with Differentiable Sphere Tracing [Liu et al., CVPR'20]</a></li>
<li><a href="https://openaccess.thecvf.com/content_CVPR_2020/papers/Jiang_SDFDiff_Differentiable_Rendering_of_Signed_Distance_Fields_for_3D_Shape_CVPR_2020_paper.pdf">SDFDiff: Differentiable Rendering of Signed Distance Fields for 3D Shape Optimization [Jiang et al., CVPR'20]</a></li>
</ol>
<p>ã“ã“æœ€è¿‘ã®CVPRãªã©ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ“ã‚¸ãƒ§ãƒ³ã®å­¦ä¼šã§ã¯3Dã®ç ”ç©¶ãŒçˆ†ç™ºçš„ã«å¢—ãˆã¦ã„ã¦ï¼Œãƒ“ã‚¸ãƒ§ãƒ³ã¨ã‚°ãƒ©ãƒ•ã‚£ã‚¯ã‚¹ã‚’è¡Œã£ãŸã‚Šæ¥ãŸã‚Šã—ã¦ã„ã‚‹ç ”ç©¶ã‚‚å¤šã„æ°—ãŒã™ã‚‹ï¼ç‰¹ã«3Då½¢çŠ¶ã‚’ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã¨ã„ã†å•é¡Œã«ç„¦ç‚¹ãŒå½“ãŸã£ã¦ãŠã‚Šï¼Œãƒœã‚¯ã‚»ãƒ«ã‚„ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰ï¼Œãƒ¡ãƒƒã‚·ãƒ¥ãªã©ã®é›¢æ•£è¡¨ç¾ã§ã¯ãªãï¼ŒDNNã§Signed Distance Function (SDF)ã‚’ãƒ¢ãƒ‡ãƒ«åŒ– <a href="https://openaccess.thecvf.com/content_CVPR_2019/papers/Park_DeepSDF_Learning_Continuous_Signed_Distance_Functions_for_Shape_Representation_CVPR_2019_paper.pdf">[Park et al., CVPR'19]</a> ã—ãŸã‚Šï¼ŒOccupancy Functionã¨ã„ã†ç‰©ä½“ã®å†…éƒ¨ã‹å¤–éƒ¨ã‹ã‚’åˆ¤åˆ¥ã™ã‚‹2å€¤åˆ†é¡å™¨ãªã©ã‚’ãƒ¢ãƒ‡ãƒ«åŒ– <a href="https://openaccess.thecvf.com/content_CVPR_2019/papers/Mescheder_Occupancy_Networks_Learning_3D_Reconstruction_in_Function_Space_CVPR_2019_paper.pdf">[Mescheder et al., CVPR'19]</a> ã—ãŸã‚Šã—ã¦ï¼Œ3Då½¢çŠ¶ã‚’é™°é–¢æ•°è¡¨ç¾ã—ã¦ã„ã‚‹ã®ã‚’ã‚ˆãè¦‹ã‹ã‘ã‚‹ï¼</p>
<p>ã¾ãŸã“ã‚Œã¨ã¯åˆ¥ã«Differentiable Rendering <a href="https://openaccess.thecvf.com/content_cvpr_2018/papers/Kato_Neural_3D_Mesh_CVPR_2018_paper.pdf">[Kato et al., CVPR'18]</a> ã¨ã„ã†æ‰‹æ³•ãŒã‚ã‚‹ï¼ã“ã‚Œã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¾®åˆ†å¯èƒ½ã«ã—ï¼Œè¨ˆç®—ã‚°ãƒ©ãƒ•ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã§ï¼Œ3Dæ•™å¸«ãƒ‡ãƒ¼ã‚¿ã‚’å¿…è¦ã¨ã›ãšï¼Œ2Dæ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®ã¿ã§3Då½¢çŠ¶ã®å­¦ç¿’ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã§ã‚‚ã®ã§ã‚ã‚‹ï¼è¨€ã„æ›ãˆã‚Œã°ï¼Œã©ã®ã‚ˆã†ãª3Då½¢çŠ¶ã‚’å­¦ç¿’ã™ã‚Œã°ï¼Œãã‚Œã«ã‚ˆã£ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸçµæœãŒæ•™å¸«ã§ã‚ã‚‹2Dãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã™ã‚‹ã‹ï¼Œã¨ã„ã†ã“ã¨ã‚’å­¦ç¿’ã™ã‚‹ï¼ä¾‹ãˆã°ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã®å¤§éƒ¨åˆ†ã¯å¹¾ä½•è¨ˆç®—ã§ã‚ã‚Šå¾®åˆ†å¯èƒ½ã§ã‚ã‚‹ãŒï¼Œãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºã ã‘ã¯å¾®åˆ†ã§ããªã„ï¼ãã“ã§æ§˜ã€…ãªè¿‘ä¼¼å‹¾é…ãŒææ¡ˆã•ã‚Œã¦ã„ã‚‹ï¼</p>
<br>
<div align="center">
<img src="differentiable_rendering.png" width="800">
<p><span>Differentiable Rendering: A Survey [Kato et al., 2020]</span></p>
</div>
<br>
<p>ä»Šå›ã®3ã¤ã®è«–æ–‡ã¯å…¨ã¦ï¼ŒDNNã§é™°é–¢æ•°è¡¨ç¾ã•ã‚ŒãŸ3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾®åˆ†å¯èƒ½ãªå½¢ã§ã©ã†è¨ˆç®—ã‚°ãƒ©ãƒ•ã«çµ„ã¿è¾¼ã‚€ã‹ï¼Œã¨ã„ã†å•é¡Œã‚’æ‰±ã£ã¦ã„ã‚‹ï¼é™°é–¢æ•°è¡¨ç¾ã•ã‚ŒãŸ3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯ã¾ã•ã—ããƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã§ã‚ã‚‹ï¼ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚’å¾®åˆ†å¯èƒ½ãªå½¢ã§è¨ˆç®—ã‚°ãƒ©ãƒ•ã«çµ„ã¿è¾¼ã‚ã‚Œã°ï¼Œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é€šã—ã¦DNNã‚’æœ€é©åŒ–ã§ãã‚‹ï¼</p>
<p>ä»Šå›ã®ç›®æ¨™ã¯ï¼Œã¾ãšã“ã‚Œã‚‰ã®è«–æ–‡ã‚’ç†è§£ã—ï¼Œå®Ÿè£…ã—ï¼Œå­¦ç¿’ã•ã›ã‚‹ï¼æ¬¡ã«å­¦ç¿’ã•ã‚ŒãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’Signed Distance Functionã¨ã—ã¦GLSLã«ã¶ã¡ã“ã¿ãã®ã¾ã¾ã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã‚„ã‚‹ï¼ã“ã‚Œã§å­¦ç¿’ã•ã‚ŒãŸ3Då½¢çŠ¶ã‚’ãã®ã¾ã¾ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã‚‹ã¯ãšã§ã‚ã‚‹ï¼</p>
<p>ã¾ãšä»Šå›ã®å•é¡Œè¨­å®šã‚’å®šå¼åŒ–ã™ã‚‹ï¼DVR [1] ã®æ‰‹æ³•ãŒæœ€ã‚‚æ´—ç·´ã•ã‚Œã¦ã„ã‚‹æ°—ãŒã—ãŸã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«ç†è§£ã‚’é€²ã‚ã‚‹ã“ã¨ã«ã—ãŸï¼
ã¾ãš3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å½¢çŠ¶ã¯$$f_{\theta}: \mathbb{R}^{3} \times \mathcal{Z} \rightarrow \mathbb{R}$$ã§é™°é–¢æ•°è¡¨ç¾ã™ã‚‹ï¼ã“ã‚Œã¯Signed Distance Functionã§ã‚‚Occupancy Functionã§ã‚‚è‰¯ã„ï¼
3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¯$$t_{\theta}: \mathbb{R}^{3} \times \mathcal{Z} \rightarrow \mathbb{R}^{3}$$ã§è¡¨ç¾ã™ã‚‹ï¼å…±ã«$z \in \mathcal{Z}$ã¯3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å½¢çŠ¶ï¼Œãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’è¡¨ã™åŸ‹ã‚è¾¼ã¿è¡¨ç¾ã§ã‚ã‚Šï¼Œ2Dè¡¨ç¾ã‹ã‚‰DNNã§ç²å¾—ã™ã‚‹ï¼</p>
<p>ã‚ˆã£ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸ2Dè¡¨ç¾ã‚’$\hat{I}$ã¨ã™ã‚‹ã¨ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªæœ€é©åŒ–å•é¡Œã‚’è§£ããŸã„ã‚ã‘ã§ã‚ã‚‹ï¼
$$\theta^{*}=\text{argmin}_{\theta}\mathcal{L}(\hat{I}, I)$$</p>
<p>å‹¾é…æ³•ã§æœ€é©åŒ–ã™ã‚‹ã¨ã—ã¦
$$\cfrac{\partial{\mathcal{L}}}{\partial{\theta}}=\sum_{u}\cfrac{\partial{\mathcal{L}}}{\partial{\hat{I}_{u}}}\cfrac{\partial{\hat{I}_{u}}}{\partial{\theta}}$$</p>
<br>
<div align="center">
<img src="ray_casting.png" width="400">
<p><span>DVR [Niemeyer et al., CVPR'20]</span></p>
</div>
<br>
<p>ã“ã“ã§$f_{\theta}$ã‚’ç”¨ã„ã¦ãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ãŸçµæœã®äº¤ç‚¹ã‚’$\hat{p}$ã¨ã™ã‚‹ã¨ï¼Œ$\hat{I}_{u}=t_{\theta}(\hat{p})$ã§ã‚ã‚‹ã‹ã‚‰ï¼Œ
$$\cfrac{\partial{\hat{I}_{u}}}{\partial{\theta}}=\cfrac{\partial{t_{\theta}(\hat{p})}}{\partial{\theta}}+\cfrac{\partial{t_{\theta}(\hat{p})}}{\partial{\hat{p}}}\cdot\cfrac{\partial{\hat{p}}}{\partial{\theta}}$$</p>
<p>ã“ã“ã§$\cfrac{\partial{\hat{p}}}{\partial{\theta}}$ã¯é™½ã«ã¯è¨ˆç®—ã§ããªã„ãŒï¼Œ$f_{\theta}(\hat{p})=0$ã®é™°é–¢æ•°å¾®åˆ†ã«ã‚ˆã‚Šï¼Œ
$$\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\theta}}+\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\hat{p}}}\cdot\cfrac{\partial{\hat{p}}}{\partial{\theta}}=0$$</p>
<p>ã“ã“ã§ãƒ¬ã‚¤ã‚’$r(d)=r_{0}+dw$ã¨è¡¨ã™ã¨ï¼Œ$\hat{p}=r(\hat{d})$ã¨è¡¨ã›ï¼Œ</p>
<p>$$\cfrac{\partial{\hat{p}}}{\partial{\theta}}=\cfrac{\partial{\hat{d}}}{\partial{\theta}}w$$</p>
<p>ã‚ˆã£ã¦ï¼Œ
$$\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\theta}}+\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\hat{p}}}\cdot\cfrac{\partial{\hat{d}}}{\partial{\theta}}w=0$$</p>
<p>$$\cfrac{\partial{\hat{d}}}{\partial{\theta}}=-(\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\hat{p}}} \cdot w)^{-1}\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\theta}}$$</p>
<p>ã™ãªã‚ã¡ï¼Œ
$$\cfrac{\partial{\hat{p}}}{\partial{\theta}}=-(\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\hat{p}}} \cdot w)^{-1}\cfrac{\partial{f_{\theta}(\hat{p})}}{\partial{\theta}}w$$</p>
<p>ã“ã‚Œã«ã‚ˆã‚Šï¼Œãƒ¬ã‚¤ã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹äº¤ç‚¹$\hat{p}$ã‚’å¾®åˆ†å¯èƒ½ãªå½¢ã§æ±‚ã‚ã‚‹å¿…è¦ã¯ãªã„ï¼
ä¾‹ãˆã°DVR [1] ã§ã¯ãƒ¬ã‚¤ä¸Šã®ç‚¹ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ï¼ŒOccupancy Networkã®å‡ºåŠ›ãŒåˆã‚ã¦0.5ã‚’è·¨ã„ã ç‚¹ï¼ˆOccupancy Networkã¯ä¸ãˆã‚‰ã‚ŒãŸç‚¹ãŒ3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…éƒ¨ã«å­˜åœ¨ã™ã‚‹ç¢ºç‡ã‚’å‡ºåŠ›ã™ã‚‹ã®ã§ï¼Œå‡ºåŠ›ãŒ0.5ã¨ãªã‚‹ç‚¹ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¡¨é¢ã«å­˜åœ¨ã™ã‚‹ã¨æ¨å®šã•ã‚ŒãŸã“ã¨ã«ãªã‚‹ï¼‰ã‚’äº¤ç‚¹$\hat{p}$ã¨ã—ã¦ã„ã‚‹ï¼</p>
<p>ä»–ã«ã‚‚DIST [2], SDFDiff [3] ã§ã¯ã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚’ç”¨ã„ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ãŠã‚Šï¼Œå¾®åˆ†å¯èƒ½ãªå½¢ã§äº¤ç‚¹$\hat{p}$ã‚’æ±‚ã‚ã‚‹å·¥å¤«ã‚’ã—ã¦ã„ã‚‹ï¼</p>
<br>
<div align="center">
<img src="sphere_tracing.png" width="400">
<img src="algorithm.png" width="400">
<p><span>DIST [Liu et al., CVPR'20]</span></p>
</div>
<br>
<p>DIST [2] ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæˆ¦ç•¥ã‚’ç”¨ã„ã¦ã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚’åŠ é€Ÿã•ã›ã¦ã„ã‚‹ï¼
ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¯ã«è¨ˆç®—ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹ã®ã§è¨ˆç®—é‡ãŒå¤šãï¼Œãã®ãŸã‚è¿‘ä¼¼å‹¾é…ã‚’ç”¨ã„ã¦å¯¾å‡¦ã—ã¦ã„ã‚‹ï¼
ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¯ã«ç´ ç›´ã«DNNã‚’é€šã—ã¦è·é›¢ã‚’è¨ˆç®—ã—ã¦ã„ã¦ã¯ï¼Œè¨ˆç®—ã‚°ãƒ©ãƒ•ãŒè‚¥å¤§åŒ–ã—ï¼Œã‚„ãŒã¦VRAMã‚’é£Ÿã„æ½°ã™ã ã‚ã†ï¼</p>
<br>
<div align="center">
<img src="strategies.png" width="800">
<p><span>DIST [Liu et al., CVPR'20]</span></p>
</div>
<br>
<p>SDFDiff [3] ã¯ï¼Œã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã«ãŠã‘ã‚‹æœ€å¾Œã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿è¨ˆç®—ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã§ï¼Œå¾®åˆ†å¯èƒ½ãªå½¢ã§äº¤ç‚¹$\hat{p}$ã‚’æ±‚ã‚ã¦ã„ã‚‹ï¼ã‚³ã‚¢ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã‚ã‚‹ï¼</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># --- ray marching --- #</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">+=</span> <span class="n">SDF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>

<span class="c1"># make only the last step differentiable</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">SDF</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
</code></pre></div><p>ã“ã®è«–æ–‡ã®Signed Distance Functionã¯ãƒœã‚¯ã‚»ãƒ«ãƒ™ãƒ¼ã‚¹ãªã®ã§ï¼Œä»»æ„ã®ç‚¹ã«ãŠã‘ã‚‹è·é›¢ã¯è¿‘å‚ãƒœã‚¯ã‚»ãƒ«ã®ç·šå½¢è£œé–“ã§æ±‚ã‚ã¦ã„ã‚‹ï¼</p>
<p>ã‚³ã‚¢ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯å¤šåˆ†ç†è§£ã§ããŸã®ã§ï¼Œå®Ÿè£…ã«ç§»ã‚‹ï¼
ä»Šå›ã¯ DVR [1] ã‚’ãƒ™ãƒ¼ã‚¹ã«Occupancy Functionã§ã¯ãªãSigned Distance Functionã‚’DNNã§ãƒ¢ãƒ‡ãƒ«åŒ–ã—ãŸï¼
å­¦ç¿’ã®æµã‚Œã¨ã—ã¦ã¯ï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«è¡Œã£ãŸï¼è«–æ–‡ã®å†ç¾ã¯ç›®çš„ã§ã¯ãªã„ã®ã§ï¼Œå®Ÿé¨“è¨­å®šã¯ç•°ãªã£ã¦ã„ã‚‹ï¼
è‡ªåˆ†ãªã‚Šã«ç†è§£ã—ã‚„ã™ãï¼Œã¾ãšã¯ãªã‚‹ã¹ãã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã‚ˆã†ã«æ›¸ã„ãŸã®ã§ï¼Œå®Ÿè£…ã¯å…ƒè«–æ–‡ã¨ã¯ã ã„ã¶é•ã†ã‹ã‚‚ã—ã‚Œãªã„ï¼
ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ã¯&quot;Single-View Reconstruction with Multi-View
Supervision&quot;ã‚’æ‰±ã†ï¼</p>
<ol>
<li>3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ãŸã‚«ãƒ¡ãƒ©ï¼Œãƒ©ã‚¤ãƒˆï¼Œãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ç”¨ã„ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ï¼Œã“ã‚Œã‚’GTã¨ã™ã‚‹ï¼</li>
<li>Signed Distance Function $f_{\theta}$ ã‚’ç”¨ã„ã¦ï¼Œã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã«ã‚ˆã‚Š3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã®äº¤ç‚¹ã‚’æ¨å®šã™ã‚‹ï¼æ³•ç·šã¯é™°é–¢æ•°ã®å‹¾é…ã§ä¸ãˆã‚‰ã‚Œã‚‹ã®ã§ï¼Œç´ ç›´ã«å¾®åˆ†ã™ã‚‹ã‹ï¼Œæœ‰é™å·®åˆ†ã§è¿‘ä¼¼ã™ã‚‹ã‹ã—ã¦æ±‚ã‚ã‚‹ï¼</li>
<li>GTã®ã‚«ãƒ¡ãƒ©ï¼Œãƒ©ã‚¤ãƒˆï¼Œãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ç”¨ã„ã¦ãƒ•ã‚©ãƒ³ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚Šæ¨å®šã•ã‚ŒãŸ3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ï¼ã¾ãŸã“ã®æ™‚ä½¿ç”¨ã•ã‚Œã‚‹ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¯ $t_{\theta}$ ã«ã‚ˆã‚Šæ¨å®šã™ã‚‹ï¼</li>
<li>Backpropã«ã‚ˆã‚Šï¼Œå„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãŠã‘ã‚‹å‹¾é…ã‚’æ±‚ã‚ã‚‹ï¼ã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã«ã‚ˆã‚‹äº¤ç‚¹ã®å¾®åˆ†ã¯é™°é–¢æ•°å¾®åˆ†ã‚’ç”¨ã„ã¦æ±‚ã‚ã‚‹ï¼</li>
</ol>
<p>ä»Šå›ã¯GTã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚„ï¼Œåå°„ãƒ¢ãƒ‡ãƒ«ï¼Œå¹¾ä½•å¤‰æ›ã®ãŸã‚ã«<a href="https://github.com/facebookresearch/pytorch3d">PyTorch3D</a>ã‚’ç”¨ã„ãŸï¼ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ã—ã¦ã¯<a href="https://www.shapenet.org/">ShapeNetCore</a>ã‚’ç”¨ã„ãŸï¼
ã“ã®ShapeNetCoreï¼Œ3Dãƒ¢ãƒ‡ãƒ«ãŒæ±šã„ãŸã‚ã‹ï¼Œæ™®é€šã«ãƒ•ã‚©ãƒ³ã‚·ã‚§ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã¨ï¼Œã‚ã¡ã‚ƒãã¡ã‚ƒãªã‚·ã‚§ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ãªã£ãŸï¼
ãªã®ã§ï¼ŒGTã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«ã¯ã¨ã‚Šã‚ãˆãšãƒ•ãƒ©ãƒƒãƒˆã‚·ã‚§ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç”¨ã„ã¦ã„ã‚‹ï¼</p>
<br>
<div align="center">
<img src="car.png" width="350"><img src="motorbike.png" width="350">
<p><span>ShapeNetCore</span></p>
</div>
<br>
<p>ã¾ãšã¯æ™®é€šã®ã‚¹ãƒ•ã‚£ã‚¢ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã‚’PyTorchã§å®Ÿè£…ã—ã¦ã¿ã‚‹ï¼
ã‚«ãƒ¡ãƒ©ã‚„ãƒ©ã‚¤ãƒˆã¯PyTorch3Dã®ã‚¯ãƒ©ã‚¹ã‚’ç”¨ã„ã¦ã„ã‚‹ï¼
PyTorch3Dã¯ã‹ãªã‚Šæ–°ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¾ã æ´—ç·´ã•ã‚Œã¦ã„ãªã„éƒ¨åˆ†ã‚‚å¤šãï¼Œçµæ§‹è‹¦åŠ´ã—ãŸï¼
ç‰¹ã«ãƒ†ãƒ³ã‚½ãƒ«ã®å½¢çŠ¶ã®ãƒŸã‚¹ãƒãƒƒãƒã«èµ·å› ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãŒå¤šãï¼Œè‡ªåˆ†ã§æ›¸ãç›´ã—ã¦ã„ã‹ãªã„ã¨ã„ã‘ãªã‹ã£ãŸï¼
ã¨ã¯ã„ãˆï¼ŒPyTorchã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è‡ªç„¶ã«çµ„ã¿è¾¼ã‚ã‚‹ã®ã¯ã¨ã¦ã‚‚ã‚ã‚ŠãŒãŸã„ã“ã¨ã§ã‚ã‚‹ï¼</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sphere_tracing</span><span class="p">(</span>
    <span class="n">signed_distance_function</span><span class="p">,</span> 
    <span class="n">positions</span><span class="p">,</span> 
    <span class="n">directions</span><span class="p">,</span> 
    <span class="n">embeddings</span><span class="p">,</span> 
    <span class="n">foreground_masks</span><span class="p">,</span> 
    <span class="n">num_iterations</span><span class="p">,</span> 
    <span class="n">convergence_threshold</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;-------- sphere tracing started --------&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span><span class="p">):</span>
        <span class="n">signed_distances</span> <span class="o">=</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span> <span class="o">+</span> <span class="n">directions</span> <span class="o">*</span> <span class="n">signed_distances</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signed_distances</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">convergence_threshold</span>
        <span class="n">convergence_rate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">converged</span><span class="p">[</span><span class="n">foreground_masks</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;iteration {i}: {convergence_rate * 100}</span><span class="si">% c</span><span class="s2">onverged&#34;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">converged</span><span class="p">[</span><span class="n">foreground_masks</span><span class="p">]):</span>
            <span class="k">break</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;-------- sphere tracing finished --------&#34;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">converged</span>


<span class="k">def</span> <span class="nf">compute_normal</span><span class="p">(</span><span class="n">signed_distance_function</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">finite_difference_epsilon</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">finite_difference_epsilon</span><span class="p">:</span>
        <span class="n">finite_difference_epsilon</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">finite_difference_epsilon</span><span class="p">)</span>
        <span class="n">finite_difference_epsilon</span> <span class="o">=</span> <span class="n">finite_difference_epsilon</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">finite_difference_epsilon_x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">finite_difference_epsilon</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">finite_difference_epsilon_y</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">finite_difference_epsilon</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">finite_difference_epsilon_z</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">finite_difference_epsilon</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">normals_x</span> <span class="o">=</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span> <span class="o">+</span> <span class="n">finite_difference_epsilon_x</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span> <span class="o">-</span> <span class="n">finite_difference_epsilon_x</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
        <span class="n">normals_y</span> <span class="o">=</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span> <span class="o">+</span> <span class="n">finite_difference_epsilon_y</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span> <span class="o">-</span> <span class="n">finite_difference_epsilon_y</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
        <span class="n">normals_z</span> <span class="o">=</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span> <span class="o">+</span> <span class="n">finite_difference_epsilon_z</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span> <span class="o">-</span> <span class="n">finite_difference_epsilon_z</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
        <span class="n">normals</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">normals_x</span><span class="p">,</span> <span class="n">normals_y</span><span class="p">,</span> <span class="n">normals_z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">create_graph</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">requires_grad</span>
        <span class="n">positions</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
            <span class="n">signed_distances</span> <span class="o">=</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
            <span class="n">normals</span><span class="p">,</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">signed_distances</span><span class="p">,</span> 
                <span class="n">inputs</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> 
                <span class="n">grad_outputs</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">signed_distances</span><span class="p">),</span>
                <span class="n">create_graph</span><span class="o">=</span><span class="n">create_graph</span><span class="p">,</span>
            <span class="p">)</span>
    
    <span class="n">normals</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normals</span>


<span class="k">def</span> <span class="nf">phong_shading</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">normals</span><span class="p">,</span> <span class="n">textures</span><span class="p">,</span> <span class="n">cameras</span><span class="p">,</span> <span class="n">lights</span><span class="p">,</span> <span class="n">materials</span><span class="p">):</span>
    <span class="n">light_diffuse_color</span> <span class="o">=</span> <span class="n">lights</span><span class="o">.</span><span class="n">diffuse</span><span class="p">(</span>
        <span class="n">normals</span><span class="o">=</span><span class="n">normals</span><span class="p">,</span> 
        <span class="n">points</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">light_specular_color</span> <span class="o">=</span> <span class="n">lights</span><span class="o">.</span><span class="n">specular</span><span class="p">(</span>
        <span class="n">normals</span><span class="o">=</span><span class="n">normals</span><span class="p">,</span>
        <span class="n">points</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span>
        <span class="n">camera_position</span><span class="o">=</span><span class="n">cameras</span><span class="o">.</span><span class="n">get_camera_center</span><span class="p">(),</span>
        <span class="n">shininess</span><span class="o">=</span><span class="n">materials</span><span class="o">.</span><span class="n">shininess</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ambient_colors</span> <span class="o">=</span> <span class="n">materials</span><span class="o">.</span><span class="n">ambient_color</span> <span class="o">*</span> <span class="n">lights</span><span class="o">.</span><span class="n">ambient_color</span>
    <span class="n">diffuse_colors</span> <span class="o">=</span> <span class="n">materials</span><span class="o">.</span><span class="n">diffuse_color</span> <span class="o">*</span> <span class="n">light_diffuse_color</span>
    <span class="n">specular_colors</span> <span class="o">=</span> <span class="n">materials</span><span class="o">.</span><span class="n">specular_color</span> <span class="o">*</span> <span class="n">light_specular_color</span>
    <span class="c1"># NOTE: pytorch3d.renderer.phong_shading should be fixed as well</span>
    <span class="k">assert</span> <span class="n">diffuse_colors</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">specular_colors</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ambient_colors</span> <span class="o">=</span> <span class="n">ambient_colors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">diffuse_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="n">ambient_colors</span> <span class="o">+</span> <span class="n">diffuse_colors</span><span class="p">)</span> <span class="o">*</span> <span class="n">textures</span> <span class="o">+</span> <span class="n">specular_colors</span>
    <span class="k">return</span> <span class="n">colors</span>
</code></pre></div><br>
<div align="center">
<img src="sphere.png" width="300">
</div>
<br>
<p>çµæ§‹ä¸å®‰ã ãŒï¼Œä¸€å¿œå˜ä½çƒé¢ã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã¦ã„ãã†ãªã®ã§ï¼Œã“ã‚Œã‚’è‡ªå‹•å¾®åˆ†ã®æ çµ„ã¿ã«çµ„ã¿è¾¼ã‚€ï¼
åŸºæœ¬çš„ã«ã¯ä¸Šè¨˜ã®<code>sphere_tracing(...)</code>ã‚’<code>torch.autograd.Function.forward(...)</code>ã«ç§»æ¤ã—ï¼Œ
<code>torch.autograd.Function.backward(...)</code>ã‚’é™°é–¢æ•°å¾®åˆ†ã«ã—ãŸãŒã£ã¦å®Ÿè£…ã™ã‚Œã°è‰¯ã•ãã†ã§ã‚ã‚‹ï¼</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">SphereTracing</span><span class="p">(</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="n">ctx</span><span class="p">,</span> 
        <span class="n">signed_distance_function</span><span class="p">,</span> 
        <span class="n">positions</span><span class="p">,</span> 
        <span class="n">directions</span><span class="p">,</span> 
        <span class="n">embeddings</span><span class="p">,</span> 
        <span class="n">foreground_masks</span><span class="p">,</span> 
        <span class="n">num_iterations</span><span class="p">,</span> 
        <span class="n">convergence_threshold</span><span class="p">,</span>
        <span class="o">*</span><span class="n">parameters</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># vanilla sphere tracing</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">positions</span><span class="p">,</span> <span class="n">converged</span> <span class="o">=</span> <span class="n">sphere_tracing</span><span class="p">(</span>
                <span class="n">signed_distance_function</span><span class="o">=</span><span class="n">signed_distance_function</span><span class="p">,</span> 
                <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> 
                <span class="n">directions</span><span class="o">=</span><span class="n">directions</span><span class="p">,</span> 
                <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span>
                <span class="n">foreground_masks</span><span class="o">=</span><span class="n">foreground_masks</span><span class="p">,</span>
                <span class="n">num_iterations</span><span class="o">=</span><span class="n">num_iterations</span><span class="p">,</span> 
                <span class="n">convergence_threshold</span><span class="o">=</span><span class="n">convergence_threshold</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">converged</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">positions</span><span class="p">))</span>

        <span class="c1"># save tensors for backward pass</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">foreground_masks</span><span class="p">,</span> <span class="n">converged</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">signed_distance_function</span> <span class="o">=</span> <span class="n">signed_distance_function</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>

        <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">converged</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_outputs</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        
        <span class="c1"># restore tensors from forward pass</span>
        <span class="n">positions</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">foreground_masks</span><span class="p">,</span> <span class="n">converged</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span>
        <span class="n">signed_distance_function</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">signed_distance_function</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">parameters</span>

        <span class="c1"># compute gradients using implicit differentiation</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">enable_grad</span><span class="p">():</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">positions</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">signed_distances</span> <span class="o">=</span> <span class="n">signed_distance_function</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
            <span class="n">grad_positions</span><span class="p">,</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">signed_distances</span><span class="p">,</span> 
                <span class="n">inputs</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> 
                <span class="n">grad_outputs</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">signed_distances</span><span class="p">),</span> 
                <span class="n">retain_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">grad_outputs_dot_directions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grad_outputs</span> <span class="o">*</span> <span class="n">directions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">grad_positions_dot_directions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grad_positions</span> <span class="o">*</span> <span class="n">directions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c1"># NOTE: avoid division by zero</span>
            <span class="n">grad_positions_dot_directions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">grad_positions_dot_directions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grad_positions_dot_directions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">grad_positions_dot_directions</span><span class="p">,</span> <span class="o">+</span><span class="mf">1e-6</span><span class="p">)),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">grad_positions_dot_directions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">grad_positions_dot_directions</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-6</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">grad_outputs</span> <span class="o">=</span> <span class="o">-</span><span class="n">grad_outputs_dot_directions</span> <span class="o">/</span> <span class="n">grad_positions_dot_directions</span>
            <span class="c1"># NOTE: zero gradient for unconverged points </span>
            <span class="c1"># grad_outputs = torch.where(converged, grad_outputs, torch.zeros_like(grad_outputs))</span>
            <span class="n">grad_embeddings</span><span class="p">,</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">signed_distances</span><span class="p">,</span> 
                <span class="n">inputs</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span> 
                <span class="n">grad_outputs</span><span class="o">=</span><span class="n">grad_outputs</span><span class="p">,</span> 
                <span class="n">retain_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">grad_parameters</span> <span class="o">=</span> <span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">signed_distances</span><span class="p">,</span> 
                <span class="n">inputs</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> 
                <span class="n">grad_outputs</span><span class="o">=</span><span class="n">grad_outputs</span><span class="p">,</span> 
                <span class="n">retain_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">grad_embeddings</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">grad_parameters</span><span class="p">)</span>
</code></pre></div><p>ã“ã‚Œã§ä¸€å¿œå­¦ç¿’ã•ã›ã¦ã¿ã‚‹ãŒï¼Œã©ã†ã›æœ€åˆã‹ã‚‰ã†ã¾ãã¯ã„ã‹ãªã„ã®ã§ï¼Œé©å®œä¿®æ­£ã‚’åŠ ãˆã¦ã„ãã“ã¨ã«ãªã‚‹ã ã‚ã†ï¼
æå¤±é–¢æ•°ã¯å˜ç´”ãªL1 lossã‚’ç”¨ã„ã¦ã¿ãŸãŒï¼ŒSDFDiff [3] ã§ææ¡ˆã•ã‚Œã¦ã„ã‚‹Signed Distance Functionã®å‹¾é…ã‚„ãƒ©ãƒ—ãƒ©ã‚·ã‚¢ãƒ³ã«é–¢ã™ã‚‹æ­£å‰‡åŒ–é …ã‚’å…¥ã‚ŒãŸã‚Šï¼Œä»–ã«ã‚‚å®Ÿè£…ãƒ¬ãƒ™ãƒ«ã®æ§˜ã€…ãªãƒˆãƒªãƒƒã‚¯ãŒå¿…è¦ã«ãªã£ã¦ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ï¼</p>
<p>çµæœã¯ã†ã¾ãã„ãæ¬¡ç¬¬è¼‰ã›ã‚ˆã†ã¨æ€ã†ï¼</p>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://hirokisakuma.com/tags/neural-network/">neural network</a>
                                    
                                    <a href="https://hirokisakuma.com/tags/computer-graphics/">computer graphics</a>
                                    
                                    <a href="https://hirokisakuma.com/tags/differentiable-renderirng/">differentiable renderirng</a>
                                    
                                    <a href="https://hirokisakuma.com/tags/sphere-tracing/">sphere tracing</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div class="footer_slogan">
        <span>Â¯\_(ãƒ„)_/Â¯</span>
    </div>
</footer>
    <script src="https://hirokisakuma.com/js/jquery-3.5.1.min.js"></script>
<link href="https://hirokisakuma.com/css/fancybox.min.css" rel="stylesheet">
<script src="https://hirokisakuma.com/js/fancybox.min.js"></script>
<script src="https://hirokisakuma.com/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-179623902-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>